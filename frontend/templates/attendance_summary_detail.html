{% extends "base.html" %}
{% load static %}

{% block title %}Attendance Details{% endblock %}

{% block content %}
<div class="card shadow-lg rounded border-gray-400">
    <div class="card-header d-flex justify-content-between align-items-center border-bottom-gray-400">
        <h3 class="mb-0 text-uppercase fw-bold flex-grow-1 text-center">Attendance Details for {{ employee.name }}</h3>
    </div>

    <div class="card-body p-3">

        <!-- Date Range Form -->
        <form class="ajax-form row g-3 align-items-end" 
              data-url="/api/attendance-summary-detail/{{ employee.id }}/" 
              data-redirect="" 
              data-error-message="Error fetching records." 
              novalidate>
            {% csrf_token %}

            <div class="col-md-4">
                <label for="from_date" class="form-label">From Date</label>
                <input type="text" class="form-control flatpickr" id="from_date" name="from_date"
                       placeholder="Start Date" required
                       value="{{ min_date }}"
                       data-min-date="{{ min_date }}" data-max-date="{{ max_date }}">
            </div>

            <div class="col-md-4">
                <label for="to_date" class="form-label">To Date</label>
                <input type="text" class="form-control flatpickr" id="to_date" name="to_date"
                       placeholder="End Date" required
                       value="{{ max_date }}"
                       data-min-date="{{ min_date }}" data-max-date="{{ max_date }}">
            </div>

            <div class="col-md-4">
                <button type="submit" class="btn btn-dark w-100">Fetch Records</button>
            </div>
        </form>

        <!-- Table -->
        <div class="table-responsive mt-3">
            <table class="table table-striped table-bordered" id="attendance-detail-table">
                <thead>
                    <tr>
                        <th style="width:60px">S. No</th>
                        <th class="text-center">Date</th>
                        <th class="text-center">Status</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="3" class="text-center">Loading records...</td>
                    </tr>
                </tbody>
            </table>
        </div>

    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(function () {
    // Initialize Flatpickr
    $(".flatpickr").each(function() {
        flatpickr(this, {
            dateFormat: "Y-m-d",
            minDate: $(this).data("min-date"),
            maxDate: $(this).data("max-date")
        });
    });

    function fetchRecords() {
        const formData = {
            from_date: $("#from_date").val(),
            to_date: $("#to_date").val()
        };

        $.ajax({
            url: $(".ajax-form").data("url"),
            type: "POST",
            headers: { "X-CSRFToken": $("input[name=csrfmiddlewaretoken]").val() },
            data: JSON.stringify(formData),
            contentType: "application/json",
            success: function(data) {
                const tbody = $("#attendance-detail-table tbody");
                tbody.empty();
                if (!data.length) {
                    tbody.append(`<tr><td colspan="3" class="text-center">No records found for this date range.</td></tr>`);
                    return;
                }
                data.forEach((rec, idx) => {
                    tbody.append(`
                        <tr>
                            <td>${idx + 1}</td>
                            <td class="text-center">${rec.date}</td>
                            <td class="text-center">${rec.status}</td>
                        </tr>
                    `);
                });
            },
            error: function(xhr) {
                const msg = xhr.responseJSON ? JSON.stringify(xhr.responseJSON) : "Error fetching records.";
                alert(msg);
            }
        });
    }

    // AJAX form submit
    $(document).on("submit", ".ajax-form", function(e) {
        e.preventDefault();
        if (!this.checkValidity()) {
            alert("Please select both From and To dates.");
            return;
        }
        fetchRecords();
    });

    // Fetch automatically on page load
    if ($("#from_date").val() && $("#to_date").val()) {
        fetchRecords();
    }
});
</script>
{% endblock %}
